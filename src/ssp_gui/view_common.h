/**
 *
 * 文 件 名 : view_common.h
 * 创建日期 : 2015-7-30 11:04
 * 作    者 : 褚冰冰
 * 修改日期 : 2015-7-30 11:04
 * 当前版本 : 1.0
 * 功能描述 : 通用数据库操作窗口
 * 修改记录 : 
 *            $Log: $
 *
 * Ver  Date        Author  Comments
 * ---  ----------  ------  -------------------------------------------
 * 001	2015-7-30 	褚冰冰　通用数据库操作窗口
 *
 **/

#ifndef VIEW_COMMON_H
#define VIEW_COMMON_H

#include <QWidget>
#include "ui_view_common.h"
#include "ssp_baseview.h"
#include "db/mysql/SMySQL.h"
#include "dbInteraction.h"
#include "include_macdef.h"
#include "structDefine.h"
#include "ssp_datawindow.h"
#include "mtreewidget.h"
#include "mcombobox.h"
#include "record_sql.h"
#include "clearData.h"
#include "qt/SQt.h"

//////////////////////////////////////////////////////////////////////////
// 名    称:  view_common
// 作    者:  褚冰冰
// 创建时间:  2015-7-30 11:05
// 描    述:  数据库操作通用窗口
//////////////////////////////////////////////////////////////////////////
class view_common : public CBaseView,public clearData
{
	Q_OBJECT

public:
	view_common(QWidget *parent = 0,SString sFunName="");
	virtual ~view_common();

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  初始化数据窗口
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 11:13
	// 参数说明:  @sWname 配置文件中dataset引用名
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void InitDataWindow(SString sWname);

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  根据不同菜单项初始化不同的窗口
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 11:16
	// 参数说明:  @sWname 配置文件中dataset引用名
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	bool InitWidget(SString sWname);//根据不同菜单项初始化不同的窗口

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  获取dataset字段信息
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 11:17
	// 参数说明:  @sWname 配置文件中dataset引用名
	//         :  @cFinfo 用来接收数据，可为空
	// 返 回 值:  从配置文件中获取到的字段信息
	//////////////////////////////////////////////////////////////////////////
	SPtrList<CSsp_DwColumn> *getFieldInfo(SString sWname,SPtrList<CSsp_DwColumn> *cFinfo=NULL);//获取字段信息

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  将通用表初始化到通用窗口
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 14:37
	// 参数说明:  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void SetCommonToWidget();//将通用表初始化到窗口（user、group）

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  将记录集中指定列的信息添加到下拉框中（引用字段在前，值字段在后）并显示指定的值
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 14:38
	// 参数说明:  @pComb 下拉框
	//         :  @rs 从配置文件中引用获取的数据集
	//		   :  @sCurrentKeyValue：tablewidget显示出来的值
	//         :  @colum 引用第几列的值（一般为1）
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void SetToComb(mCombobox * pComb,SRecordset* rs,SString sCurrentKeyValue,int colum);//将记录集中指定列的信息添加到下拉框中（引用字段在前，值字段在后）

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  根据下拉框中值从数据集中找出对应的值
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 14:43
	// 参数说明:  @pComb 下拉框
	//         :  @rs 从配置文件中引用获取的数据集
	// 返 回 值:  取到对应的值
	//////////////////////////////////////////////////////////////////////////
	SString GetFromComb(mCombobox *pComb,SRecordset* rs);//根据下拉框中值从数据集中找出对应的值

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  从sql语句中获取表名
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 14:47
	// 参数说明:  @sql 语句（只支持单张表语句）
	// 返 回 值:  表名
	//////////////////////////////////////////////////////////////////////////
	SString GetTableFromSql(SString sSql);//从sql语句中获取表名

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  窗口显示前调用函数
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 14:49
	// 参数说明:  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void OnPreShow();

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  窗口隐藏前调用函数
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 14:49
	// 参数说明:  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void OnPreHide();

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  窗口显示后调用函数
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 14:49
	// 参数说明:  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void OnAftHide();
	public slots:
	//////////////////////////////////////////////////////////////////////////
	// 描    述:  新增按钮槽函数
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 14:51
	// 参数说明:  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void on_pushButton_pressed();//新增

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  删除按钮槽函数
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 14:51
	// 参数说明:  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void on_pushButton_2_pressed();//删除

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  保存按钮槽函数
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 14:51
	// 参数说明:  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void on_pushButton_3_pressed();//保存

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  打印按钮槽函数
	// 作    者:  褚冰冰
	// 创建时间:  2015-8-5 19:27
	// 参数说明:  @
	//         :  @
	//		   :  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void on_pushButton_4_clicked();//打印

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  导出按钮槽函数
	// 作    者:  褚冰冰
	// 创建时间:  2015-8-5 19:27
	// 参数说明:  @
	//         :  @
	//		   :  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void on_pushButton_5_clicked();//导出

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  表中值发生变化槽函数
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 14:51
	// 参数说明:  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void on_tableWidget_itemChanged(QTableWidgetItem * item);

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  双击表格槽函数
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 14:51
	// 参数说明:  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void on_tableWidget_itemDoubleClicked(QTableWidgetItem * item);

	void on_tableWidget_itemClicked(QTableWidgetItem * item);

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  表选择变化槽函数
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 14:51
	// 参数说明:  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void on_tableWidget_itemSelectionChanged();

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  表格中的combobox值发生改变槽函数
	// 作    者:  褚冰冰
	// 创建时间:  2015-7-30 14:51
	// 参数说明:  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void oneCellChanged(QTableWidgetItem* item,int column);//表格中的combobox值发生改变


	//////////////////////////////////////////////////////////////////////////
	// 描    述:  当前item变化槽函数
	// 作    者:  褚冰冰
	// 创建时间:  2015-8-7 17:08
	// 参数说明:  @current  当前item
	//         :  @previous 原先的item
	//		   :  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	void on_tableWidget_currentItemChanged( QTableWidgetItem * current, QTableWidgetItem * previous );


	//////////////////////////////////////////////////////////////////////////
	// 描    述:  自动获取新增行的编号（主键为数字类型且唯一）
	// 作    者:  褚冰冰
	// 创建时间:  2015-8-3 16:12
	// 参数说明:  @
	//         :  @
	//		   :  @
	// 返 回 值:  int
	//////////////////////////////////////////////////////////////////////////
	int getAddIndex();

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  判断列是否是主键，主键不能为空且唯一
	// 作    者:  褚冰冰
	// 创建时间:  2015-8-9 14:01
	// 参数说明:  @column:列
	//         :  @
	//		   :  @
	// 返 回 值:  是返回true 不是返回false
	//////////////////////////////////////////////////////////////////////////
	bool isPkey(int column);

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  判断该列是否必须唯一
	// 作    者:  褚冰冰
	// 创建时间:  2015-8-10 10:04
	// 参数说明:  @column 列
	//         :  @
	//		   :  @
	// 返 回 值:  true：必须唯一  false:不必唯一
	//////////////////////////////////////////////////////////////////////////
	bool isUnique(int column);

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  判断字段是否可以为空
	// 作    者:  褚冰冰
	// 创建时间:  2015-8-10 10:08
	// 参数说明:  @column 列
	//         :  @
	//		   :  @
	// 返 回 值:  true：允许为空  false:不能为空
	//////////////////////////////////////////////////////////////////////////
	bool canNUll(int column);

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  返回引用列引用的字符串
	// 作    者:  褚冰冰
	// 创建时间:  2015-8-9 15:54
	// 参数说明:  @rs 为引用数据集
	//         :  @sCurrentKeyValue 数据库中原本的值
	//		   :  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	SString showAsRef(SRecordset* rs,SString sCurrentKeyValue);

	//////////////////////////////////////////////////////////////////////////
	// 描    述:  将显示出来引用的值转为实际值
	// 作    者:  褚冰冰
	// 创建时间:  2015-8-10 8:43
	// 参数说明:  @rs 引用数据集
	//         :  @sref 引用名
	//		   :  @
	// 返 回 值:  
	//////////////////////////////////////////////////////////////////////////
	SString refToValue(SRecordset* rs,SString sref);
private:
	Ui::view_common ui;
	SDatabasePool<SMySQL> *m_pPool;
	SDatabaseOper *m_pOper;
	SString m_tableName;//表名
	SString m_tableDesc;
	SString m_refName;//索引名
	SString m_pre;//修改之前的值
	SString m_old;//保存之前最初的值
	bool m_bInsert;//是否是
	CSsp_DwColumn *m_fieldInfo;//字段信息
	SPtrList<CSsp_DwColumn> *m_fieldlist;//所有字段信息
	vector<SString> m_fieldNamelist;//字段原本名称列表
	int m_nPkey;//主键数字索引
	vector<int> m_vKey;
	int m_tableRow;//不算上插入行的行数
	CSsp_DatawindowMgr *m_dataWindow;//数据窗口管理对象
	QWidget * m_widget;
	SRecordset* m_Record;
	record_sql m_sqlRecord;//命令集
	int m_comboChangeIndex;//记录引用下拉框更改的索引
	bool m_bSave;//是否保存过
	QFont m_font_underline;

	bool eventFilter(QObject *obj, QEvent *event);//事件过滤
};

#endif // VIEW_COMMON_H
